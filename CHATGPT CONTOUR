import cv2
import numpy as np
from tabulate import tabulate  # Tablo formatı için kullanılıyor
from openpyxl import Workbook  # Excel dosyası oluşturmak için kullanılıyor

# Taranacak dosyaların isimleri
file_names = [f"{i}.png" for i in range(1, 26)]

# Sonuçları saklamak için liste
results = []

# Tüm dosyaları tarama
for file_name in file_names:
    # Görsel kontrol
    try:
        image = cv2.imread(file_name, cv2.IMREAD_GRAYSCALE)
        if image is None:
            print(f"Görsel yüklenemedi: {file_name}")
            continue
    except:
        print(f"Dosya bulunamadı veya açılırken hata oluştu: {file_name}")
        continue

    # Görsel boyutları
    image_height, image_width = image.shape
    total_image_area = image_height * image_width

    # Görüntüyü ikili hale getirme (binary thresholding)
    _, binary = cv2.threshold(image, 50, 255, cv2.THRESH_BINARY_INV)

    # Parçacıkların tespiti
    contours, _ = cv2.findContours(binary, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)

    # Değişkenler
    count = len(contours)  # Parçacık sayısı
    total_area = sum(cv2.contourArea(contour) for contour in contours)

    # Ortalama boyut
    average_size = total_area / count if count > 0 else 0

    # Yüzde alan (% Area)
    percent_area = (total_area / total_image_area) * 100 if total_image_area > 0 else 0

    # Sonuçları kaydet
    results.append([
        file_name,  # Dosya adı
        count,  # Parçacık sayısı
        f"{total_area:.2f}",  # Toplam alan
        f"{average_size:.2f}",  # Ortalama boyut
        f"{percent_area:.2f}%"  # % Alan
    ])

# Sonuçları tablo olarak yazdırma
print(tabulate(
    results, 
    headers=["Dosya Adı", "Parçacık Sayısı", "Toplam Alan", "Ortalama Boyut", "% Alan"],
    tablefmt="grid"
))

# Sonuçları Excel'e yazma
workbook = Workbook()
sheet = workbook.active
sheet.title = "Sonuçlar"

# Başlıkları ekle
headers = ["Dosya Adı", "Parçacık Sayısı", "Toplam Alan", "Ortalama Boyut", "% Alan"]
sheet.append(headers)

# Verileri ekle
for row in results:
    sheet.append(row)

# Excel dosyasını kaydet
excel_file_name = "sonuclar.xlsx"
workbook.save(excel_file_name)
print(f"Sonuçlar {excel_file_name} dosyasına kaydedildi.")
